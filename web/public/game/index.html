<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horse Maze Race â€” WITH RESULTS TABLE v2025</title>
<link rel="stylesheet" href="styles/main.css">

</head>
<body>

<!-- Epic Loading Screen -->
<div id="loadingScreen" class="loading-screen">
  <div class="loading-container">
    <div class="loading-logo">
      <div class="horse-icon">ğŸ</div>
      <h1 class="game-title">HORSE MAZE RACE</h1>
      <p class="game-subtitle">Ultimate Racing Experience</p>
    </div>
    
    <div class="loading-progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
        <div class="progress-glow"></div>
      </div>
      <div class="loading-text" id="loadingText">Initializing...</div>
      <div class="loading-percentage" id="loadingPercentage">0%</div>
    </div>
    
    <div class="loading-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
    
    <div class="loading-tips">
      <div class="tip-text" id="tipText">ğŸ’¡ Tip: Use RAM power-up to eliminate opponents!</div>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- Top Editor Bar - Náº±m ngoÃ i canvas -->
  <div class="top-editor-bar" id="topEditorBar">
      <!-- ğŸ› ï¸ TOOLS Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Tools">ğŸ› ï¸</button>
        <div class="teb-dropdown-menu teb-menu-wide">
          <div class="teb-menu-section">ğŸ¯ Essential</div>
          <div class="teb-menu-grid">
            <button class="teb-menu-item" data-tool="select" title="Select">ğŸ¯</button>
            <button class="teb-menu-item" data-tool="erase" title="Erase">ğŸ—‘ï¸</button>
            <button class="teb-menu-item" data-tool="wall" title="Wall">ğŸ§±</button>
            <button class="teb-menu-item" data-tool="brush" title="Brush">ğŸ–Œï¸</button>
          </div>
          <div class="teb-menu-section">ğŸ“ Geometry</div>
          <div class="teb-menu-grid">
            <button class="teb-menu-item" data-tool="diag" title="Diagonal">ğŸ“</button>
            <button class="teb-menu-item" data-tool="semi" title="Half-Circle">ğŸŒ™</button>
            <button class="teb-menu-item" data-tool="arc" title="Arc">ğŸŒˆ</button>
            <button class="teb-menu-item" data-tool="text" title="Text">ğŸ”¤</button>
            <button class="teb-menu-item" data-tool="ebrush" title="Eraser Brush">ğŸ§¹</button>
            <button class="teb-menu-item" data-tool="breakwall" title="Break Wall">ğŸ’¥</button>
            <button class="teb-menu-item" data-tool="softwall" title="Soft Wall">ğŸ§½</button>
          </div>
        </div>
      </div>

      <!-- ğŸ RACE Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Race Setup">ğŸ</button>
        <div class="teb-dropdown-menu teb-menu-wide">
          <div class="teb-menu-section">ğŸ Race Elements</div>
          <div class="teb-menu-grid">
            <button class="teb-menu-item" data-tool="spawn" title="Spawns">ğŸ</button>
            <button class="teb-menu-item" data-tool="carrotA" title="Finish A">ğŸ¥•</button>
            <button class="teb-menu-item" data-tool="carrotB" title="Finish B">ğŸ†</button>
            <button class="teb-menu-item" data-tool="room" title="Room">ğŸ </button>
            <button class="teb-menu-item" data-tool="start" title="Start Gate">ğŸš¦</button>
          </div>
          <div class="teb-menu-section">ğŸ Spawn Settings</div>
          <div class="teb-menu-setting">
            <label>Preset</label>
            <select data-sync="spawnPreset">
              <option value="auto">Auto Grid</option>
              <option value="line">Line</option>
              <option value="grid2">Grid 2Ã—</option>
              <option value="fan">Fan/Arc</option>
              <option value="scatter">Scatter</option>
            </select>
          </div>
          <div class="teb-menu-setting">
            <label>Jitter</label>
            <input type="range" data-sync="spawnJitter" min="0" max="16" step="1" value="6">
            <span class="teb-val">6px</span>
          </div>
          <div class="teb-menu-setting">
            <label>Start Bias</label>
            <input type="range" data-sync="startBias" min="0" max="1500" step="50" value="100">
            <span class="teb-val">100ms</span>
          </div>
        </div>
      </div>

      <!-- âš¡ POWERUPS Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Power-ups">âš¡</button>
        <div class="teb-dropdown-menu teb-menu-wide">
          <div class="teb-menu-section">âš¡ Power-ups</div>
          <div class="teb-menu-grid">
            <button class="teb-menu-item" data-tool="boost" title="Boost">âš¡</button>
            <button class="teb-menu-item" data-tool="turbo" title="Turbo">ğŸš€</button>
            <button class="teb-menu-item" data-tool="ghost" title="Ghost">ğŸ‘»</button>
            <button class="teb-menu-item" data-tool="shield" title="Shield">ğŸ›¡ï¸</button>
            <button class="teb-menu-item" data-tool="teleport" title="Teleport">ğŸŒ€</button>
            <button class="teb-menu-item" data-tool="magnet" title="Magnet">ğŸ§²</button>
            <button class="teb-menu-item" data-tool="timefreeze" title="Freeze">â„ï¸</button>
            <button class="teb-menu-item" data-tool="icefreezer" title="Ice">ğŸ§Š</button>
            <button class="teb-menu-item" data-tool="poison" title="Poison">â˜ ï¸</button>
            <button class="teb-menu-item" data-tool="fireaura" title="Fire">ğŸ”¥</button>
            <button class="teb-menu-item" data-tool="healingzone" title="Heal">ğŸ’š</button>
            <button class="teb-menu-item" data-tool="tornado" title="Tornado">ğŸŒªï¸</button>
            <button class="teb-menu-item" data-tool="volcano" title="Volcano">ğŸŒ‹</button>
            <button class="teb-menu-item" data-tool="warpzone" title="Warp">ğŸŒŒ</button>
            <button class="teb-menu-item" data-tool="quantumdash" title="Quantum">ğŸ”®</button>
            <button class="teb-menu-item" data-tool="yellowheart" title="Yellow">ğŸ’›</button>
            <button class="teb-menu-item" data-tool="nebula" title="Nebula">ğŸ”¹</button>
          </div>
        </div>
      </div>

      <!-- ğŸš§ OBSTACLES Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Obstacles">ğŸš§</button>
        <div class="teb-dropdown-menu teb-menu-wide">
          <div class="teb-menu-section">ğŸš§ Obstacles</div>
          <div class="teb-menu-grid">
            <button class="teb-menu-item" data-tool="ram" title="Ram">ğŸ’¥</button>
            <button class="teb-menu-item" data-tool="mud" title="Mud">ğŸŸ¤</button>
            <button class="teb-menu-item" data-tool="healingpatch" title="Heal">ğŸ’–</button>
            <button class="teb-menu-item" data-tool="rotbarrier" title="Barrier">âš–ï¸</button>
            <button class="teb-menu-item" data-tool="firetrap" title="Fire">â˜„ï¸</button>
            <button class="teb-menu-item" data-tool="magnetpull" title="Pull">ğŸ§¿</button>
            <button class="teb-menu-item" data-tool="magnetpush" title="Push">âœ¨</button>
            <button class="teb-menu-item" data-tool="bumper" title="Bumper">ğŸŸ¦</button>
            <button class="teb-menu-item" data-tool="spinner" title="Spinner">ğŸ”„</button>
          </div>
          <div class="teb-menu-section">ğŸ”§ Advanced</div>
          <div class="teb-menu-grid">
            <button class="teb-menu-item" data-tool="belt" title="Belt">ğŸ“¦</button>
            <button class="teb-menu-item" data-tool="fan" title="Fan">ğŸ’«</button>
            <button class="teb-menu-item" data-tool="weather" title="Weather">ğŸŒ¦ï¸</button>
            <button class="teb-menu-item" data-tool="oneway" title="One-way">â›©ï¸</button>
            <button class="teb-menu-item" data-tool="pad" title="Pad">ğŸŸ©</button>
          </div>
        </div>
      </div>

      <div class="teb-divider"></div>

      <!-- âš™ï¸ SETTINGS Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Settings">âš™ï¸</button>
        <div class="teb-dropdown-menu teb-menu-wide teb-menu-scroll">
          <div class="teb-menu-section">ğŸ“ Grid</div>
          <div class="teb-menu-setting">
            <label>Grid Size</label>
            <input type="range" data-sync="grid" min="8" max="60" step="2" value="20">
            <span class="teb-val">20px</span>
          </div>
          <div class="teb-menu-setting">
            <label>Hide in Play</label>
            <input type="checkbox" data-sync="hideGridOnPlay">
          </div>
          
          <div class="teb-menu-section">ğŸ Objects</div>
          <div class="teb-menu-setting">
            <label>Horse Speed</label>
            <input type="range" data-sync="speed" min="0.5" max="30" step="0.1" value="1.0">
            <span class="teb-val">1.0Ã—</span>
          </div>
          <div class="teb-menu-setting">
            <label>Max Speed</label>
            <input type="range" data-sync="maxHorseSpeed" min="0.5" max="30" step="0.1" value="30">
            <span class="teb-val">30Ã—</span>
          </div>
          <div class="teb-menu-setting">
            <label>Horse Radius</label>
            <input type="range" data-sync="horseRadius" min="8" max="60" step="1" value="36">
            <span class="teb-val">36</span>
          </div>
          <div class="teb-menu-setting">
            <label>Carrot Size</label>
            <input type="range" data-sync="carrotRadius" min="8" max="60" step="1" value="30">
            <span class="teb-val">30</span>
          </div>
          <div class="teb-menu-setting">
            <label>Corner Radius</label>
            <input type="range" data-sync="radius" min="6" max="30" step="2" value="14">
            <span class="teb-val">14</span>
          </div>
          
          <div class="teb-menu-section">ğŸ§± Walls</div>
          <div class="teb-menu-setting">
            <label>Wall Width</label>
            <input type="range" data-sync="thick" min="6" max="80" step="2" value="24">
            <span class="teb-val">24px</span>
          </div>
          <div class="teb-menu-setting">
            <label>Round Cap</label>
            <input type="checkbox" data-sync="roundCap" checked>
          </div>
          <div class="teb-menu-setting">
            <label>Arc Span</label>
            <input type="range" data-sync="arcSpan" min="30" max="330" step="5" value="180">
            <span class="teb-val">180Â°</span>
          </div>
          <div class="teb-menu-setting">
            <label>Brush Step</label>
            <input type="range" data-sync="brushStep" min="2" max="16" step="1" value="6">
            <span class="teb-val">6px</span>
          </div>
          <div class="teb-menu-setting">
            <label>ğŸ¨ Color</label>
            <input type="color" data-sync="shapeColor" value="#607d8b">
          </div>
          
          <div class="teb-menu-section">ğŸ’¥ Break Walls</div>
          <div class="teb-menu-setting">
            <label>Break HP</label>
            <input type="range" data-sync="breakHp" min="1" max="50" step="1" value="8">
            <span class="teb-val">8</span>
          </div>
          <div class="teb-menu-setting">
            <label>On Break</label>
            <select data-sync="breakOn">
              <option value="remove">Remove</option>
              <option value="shards">Shards</option>
            </select>
          </div>
          
          <div class="teb-menu-section">ğŸ§½ Soft Walls</div>
          <div class="teb-menu-setting">
            <label>Stiffness</label>
            <input type="range" data-sync="softStiff" min="0.05" max="10" step="0.05" value="0.5">
            <span class="teb-val">0.5</span>
          </div>
          <div class="teb-menu-setting">
            <label>Max Deform</label>
            <input type="range" data-sync="softMaxDef" min="0" max="100" step="1" value="18">
            <span class="teb-val">18px</span>
          </div>
          <div class="teb-menu-setting">
            <label>Recovery</label>
            <input type="range" data-sync="softRecover" min="0" max="120" step="2" value="24">
            <span class="teb-val">24px/s</span>
          </div>
          
          <div class="teb-menu-section">ğŸ”§ Special</div>
          <div class="teb-menu-setting">
            <label>Spinner Speed</label>
            <input type="range" data-sync="spinnerSpeed" min="0.1" max="5" step="0.1" value="1.0">
            <span class="teb-val">1.0</span>
          </div>
          <div class="teb-menu-setting">
            <label>Spinner Length</label>
            <input type="range" data-sync="spinnerLength" min="20" max="240" step="5" value="80">
            <span class="teb-val">80px</span>
          </div>
          <div class="teb-menu-setting">
            <label>Mud Slowdown</label>
            <input type="range" data-sync="mudSlowdown" min="0.1" max="0.9" step="0.05" value="0.4">
            <span class="teb-val">60%</span>
          </div>
          
          <div class="teb-menu-section">ğŸ§² Magnet</div>
          <div class="teb-menu-setting">
            <label>Range</label>
            <input type="range" data-sync="magnetRange" min="50" max="400" step="10" value="100">
            <span class="teb-val">100px</span>
          </div>
          <div class="teb-menu-setting">
            <label>Duration</label>
            <input type="range" data-sync="magnetDuration" min="1000" max="10000" step="500" value="3000">
            <span class="teb-val">3000ms</span>
          </div>
          <div class="teb-menu-setting">
            <label>Power</label>
            <input type="range" data-sync="magnetPower" min="100" max="1000" step="10" value="200">
            <span class="teb-val">200</span>
          </div>
          <div class="teb-menu-setting">
            <label>Attract All</label>
            <input type="checkbox" data-sync="magnetAttractAll">
          </div>
          
          <div class="teb-menu-section">ğŸŸ¦ Bumper</div>
          <div class="teb-menu-setting">
            <label>Radius</label>
            <input type="range" data-sync="bumperRadius" min="6" max="80" step="1" value="22">
            <span class="teb-val">22</span>
          </div>
          <div class="teb-menu-setting">
            <label>Elasticity</label>
            <input type="range" data-sync="bumperElasticity" min="0.5" max="2.5" step="0.01" value="1.15">
            <span class="teb-val">1.15</span>
          </div>
          <div class="teb-menu-setting">
            <label>Noise</label>
            <input type="range" data-sync="bumperNoise" min="0" max="0.7" step="0.01" value="0.15">
            <span class="teb-val">0.15</span>
          </div>
          <div class="teb-menu-setting">
            <label>Color</label>
            <input type="color" data-sync="bumperColor" value="#7cf1ff">
          </div>
          
          <div class="teb-menu-section">ğŸŒ€ Fan</div>
          <div class="teb-menu-setting">
            <label>Radius</label>
            <input type="range" data-sync="fanRadius" min="20" max="300" step="1" value="120">
            <span class="teb-val">120</span>
          </div>
          <div class="teb-menu-setting">
            <label>Angle</label>
            <input type="range" data-sync="fanAngle" min="0" max="359" step="1" value="0">
            <span class="teb-val">0Â°</span>
          </div>
          <div class="teb-menu-setting">
            <label>Spread</label>
            <input type="range" data-sync="fanSpread" min="10" max="180" step="1" value="60">
            <span class="teb-val">60Â°</span>
          </div>
          <div class="teb-menu-setting">
            <label>Strength</label>
            <input type="range" data-sync="fanStrength" min="0" max="0.3" step="0.005" value="0.08">
            <span class="teb-val">0.08</span>
          </div>
        </div>
      </div>

      <!-- ğŸ® GAME Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Game Settings">ğŸ®</button>
        <div class="teb-dropdown-menu teb-menu-wide teb-menu-scroll">
          <div class="teb-menu-section">ğŸ® Game Settings</div>
          <div class="teb-menu-setting">
            <label>ğŸ Horses</label>
            <input type="range" data-sync="n" min="1" max="50" step="1" value="8">
            <span class="teb-val">8</span>
          </div>
          <div class="teb-menu-setting">
            <label>âš¡ Speed</label>
            <input type="range" data-sync="runtimeSpeedSlider" min="0.1" max="5" step="0.1" value="1.0">
            <span class="teb-val">1.0Ã—</span>
          </div>
          <div class="teb-menu-setting">
            <label>â±ï¸ Countdown</label>
            <input type="range" data-sync="countdownSlider" min="0" max="10" step="1" value="0">
            <span class="teb-val">0s</span>
          </div>
          <div class="teb-menu-setting">
            <label>ğŸï¸ Min Cruise</label>
            <input type="range" data-sync="minCruise" min="0" max="15" step="0.1" value="1.5">
            <span class="teb-val">1.5</span>
          </div>
          <div class="teb-menu-setting">
            <label>ğŸ”Š Collision SFX</label>
            <input type="checkbox" data-sync="collisionSfx" checked>
          </div>
          
          <div class="teb-menu-section">ğŸ’¨ Trail</div>
          <div class="teb-menu-setting">
            <label>Enable Trail</label>
            <input type="checkbox" data-sync="trailEnabled">
            <input type="color" data-sync="trailColor" value="#9e9e9e">
          </div>
          <div class="teb-menu-setting">
            <label>Intensity</label>
            <input type="range" data-sync="trailIntensity" min="0" max="1.6" step="0.05" value="1.0">
            <span class="teb-val">1.0Ã—</span>
          </div>
          
          <div class="teb-menu-section">ğŸ”¤ Display</div>
          <div class="teb-menu-setting">
            <label>ğŸ™ˆ Hide Names</label>
            <input type="checkbox" data-sync="hideHorseNames">
          </div>
          <div class="teb-menu-setting">
            <label>Name Size</label>
            <input type="range" data-sync="nameFontScale" min="0.5" max="2.0" step="0.05" value="0.55">
            <span class="teb-val">0.55Ã—</span>
          </div>
          <div class="teb-menu-setting">
            <label>âš¡ Show Speed</label>
            <input type="checkbox" data-sync="showHorseSpeed">
          </div>
          <div class="teb-menu-setting">
            <label>ğŸ”„ Auto Rotate</label>
            <input type="checkbox" data-sync="autoRotateHorseSprite">
          </div>
          
          <div class="teb-menu-section">ğŸ¥• Carrots</div>
          <div class="teb-menu-setting">
            <label>Carrot A</label>
            <input type="checkbox" data-sync="carrotAOn">
          </div>
          <div class="teb-menu-setting">
            <label>Carrot B</label>
            <input type="checkbox" data-sync="carrotBOn">
          </div>
          
          <div class="teb-menu-section">â¤ï¸ HP System</div>
          <div class="teb-menu-setting">
            <label>Enable HP</label>
            <input type="checkbox" data-sync="hpSystemEnabled">
          </div>
          <div class="teb-menu-setting">
            <label>Max HP</label>
            <input type="number" data-sync="horseMaxHP" min="1" max="9999" step="1" value="100">
          </div>
          <div class="teb-menu-setting">
            <label>Show HP #</label>
            <input type="checkbox" data-sync="showHPNumbers">
          </div>
          <div class="teb-menu-setting">
            <label>ğŸ‘‘ Last Wins</label>
            <input type="checkbox" data-sync="lastHorseWins">
          </div>
          
          <div class="teb-menu-section">ğŸ’¥ Damage</div>
          <div class="teb-menu-setting">
            <label>ğŸ§± Wall Dmg</label>
            <input type="checkbox" data-sync="wallDamageEnabled">
          </div>
          <div class="teb-menu-setting">
            <label>Amount</label>
            <input type="range" data-sync="wallDamageAmount" min="1" max="50" step="1" value="10">
            <span class="teb-val">10</span>
          </div>
          <div class="teb-menu-setting">
            <label>ğŸ”² Border Dmg</label>
            <input type="checkbox" data-sync="borderDamageEnabled">
          </div>
          <div class="teb-menu-setting">
            <label>Amount</label>
            <input type="range" data-sync="borderDamageAmount" min="1" max="50" step="1" value="15">
            <span class="teb-val">15</span>
          </div>
          
          <div class="teb-menu-section">ğŸ€ Luck</div>
          <div class="teb-menu-setting">
            <label>Luck or Suck</label>
            <input type="checkbox" data-sync="luckEnabled">
          </div>
          <div class="teb-menu-setting">
            <label>Interval (s)</label>
            <input type="number" data-sync="luckInterval" min="3" max="60" step="1" value="12">
          </div>
        </div>
      </div>

      <!-- ğŸ´ HORSE Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Horse Customization">ğŸ´</button>
        <div class="teb-dropdown-menu teb-menu-wide teb-menu-scroll">
          <div class="teb-menu-section">ğŸ´ Select Horse</div>
          <div class="teb-menu-setting">
            <label>Horse #</label>
            <input type="number" data-sync="horseIdx" min="1" max="50" value="1">
          </div>
          <div class="teb-menu-setting">
            <label>Name</label>
            <input type="text" data-sync="horseName" placeholder="Name">
          </div>
          
          <div class="teb-menu-section">âš¡ Stats</div>
          <div class="teb-menu-setting">
            <label>Speed</label>
            <input type="number" data-sync="horseSpeed" min="0.1" max="5" step="0.1" placeholder="Default">
          </div>
          <div class="teb-menu-setting">
            <label>HP</label>
            <input type="number" data-sync="horseHP" min="1" max="500" step="1" placeholder="Default">
          </div>
          <div class="teb-menu-setting">
            <label>Luck %</label>
            <input type="number" data-sync="horseLuck" min="0" max="100" step="0.1" placeholder="0">
          </div>
          
          <div class="teb-menu-section">ğŸ¨ Colors</div>
          <div class="teb-menu-setting">
            <label>Body</label>
            <input type="color" data-sync="colorBody" value="#42a5f5">
          </div>
          <div class="teb-menu-setting">
            <label>Label</label>
            <input type="color" data-sync="colorLabel" value="#1e88e5">
          </div>
          
          <div class="teb-menu-section">ğŸ–¼ï¸ Sprite</div>
          <div class="teb-menu-setting">
            <label>Scale</label>
            <input type="range" data-sync="spriteScale" min="0.5" max="2.0" step="0.05" value="1.0">
            <span class="teb-val">1.0Ã—</span>
          </div>
          <div class="teb-menu-setting">
            <label>Outline</label>
            <select data-sync="spriteOutline">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
          <div class="teb-menu-setting">
            <label>Color</label>
            <input type="color" data-sync="spriteOutlineColor" value="#000000">
          </div>
          <div class="teb-menu-setting">
            <label>Width</label>
            <input type="range" data-sync="spriteOutlineWidth" min="1" max="6" step="1" value="2">
            <span class="teb-val">2px</span>
          </div>
          
          <div class="teb-menu-section">ğŸ¯ Actions</div>
          <div class="teb-menu-actions">
            <button class="teb-action-btn" data-click="applyHorse">âœ… Apply</button>
            <button class="teb-action-btn" data-click="resetHorse">ğŸ”„ Reset</button>
            <button class="teb-action-btn" data-click="randomHorse">ğŸ² Random</button>
            <button class="teb-action-btn" data-click="randomAllHorses">ğŸ² All</button>
          </div>
        </div>
      </div>

      <!-- ğŸµ AUDIO Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Audio Settings">ğŸµ</button>
        <div class="teb-dropdown-menu teb-menu-wide">
          <div class="teb-menu-section">ğŸµ Background Music</div>
          <div class="teb-menu-setting">
            <label>Volume</label>
            <input type="range" data-sync="bgmVolume" min="0" max="1" step="0.05" value="0.5">
            <span class="teb-val">50%</span>
          </div>
          <div class="teb-menu-actions">
            <button class="teb-action-btn" data-click="bgmPause">â¸ï¸ Pause</button>
          </div>
          
          <div class="teb-menu-section">ğŸ—£ï¸ TTS</div>
          <div class="teb-menu-setting">
            <label>Enable TTS</label>
            <input type="checkbox" data-sync="ttsEnabled">
          </div>
        </div>
      </div>

      <!-- ğŸ—ºï¸ MAP Dropdown -->
      <div class="teb-dropdown">
        <button class="teb-btn teb-dropdown-toggle" title="Map Management">ğŸ—ºï¸</button>
        <div class="teb-dropdown-menu teb-menu-wide">
          <div class="teb-menu-section">ğŸ—ºï¸ Map Actions</div>
          <div class="teb-menu-actions">
            <button class="teb-action-btn" data-click="clearMap">ğŸ—‘ï¸ Clear</button>
            <button class="teb-action-btn" data-click="randomMap">ğŸ² Generate</button>
            <button class="teb-action-btn" data-click="randomItems">âœ¨ Items</button>
            <button class="teb-action-btn" data-click="loadSample">ğŸ“‹ Sample</button>
          </div>
          
          <div class="teb-menu-section">ğŸ—ºï¸ Presets</div>
          <div class="teb-menu-actions">
            <button class="teb-action-btn" data-click="preset1">ğŸ Oval</button>
            <button class="teb-action-btn" data-click="preset2">ğŸŒªï¸ Spin</button>
            <button class="teb-action-btn" data-click="preset3">ğŸ§± Maze</button>
          </div>
          
          <div class="teb-menu-section">ğŸ’¾ Save/Load</div>
          <div class="teb-menu-actions">
            <button class="teb-action-btn" data-click="exportMap">ğŸ“¤ Export</button>
            <button class="teb-action-btn" data-click="saveLS">ğŸ’¾ Save</button>
            <button class="teb-action-btn" data-click="loadLS">ğŸ“¥ Load</button>
          </div>
          
          <div class="teb-menu-section">ğŸšª Waiting Room</div>
          <div class="teb-menu-setting">
            <label>Width</label>
            <input type="number" data-sync="waitingRoomW" min="160" max="1200" step="10" value="260">
          </div>
          <div class="teb-menu-setting">
            <label>Height</label>
            <input type="number" data-sync="waitingRoomH" min="160" max="1200" step="10" value="480">
          </div>
          <div class="teb-menu-setting">
            <label>Auto-fit</label>
            <input type="checkbox" data-sync="autoFitWaitingRoom" checked>
          </div>
        </div>
      </div>

      <div class="teb-divider"></div>

      <!-- Toggle Sidebar -->
      <button class="teb-btn teb-toggle-sidebar" id="tebToggleSidebar" title="áº¨n/Hiá»‡n sidebar">â‰¡</button>
    </div>

  <div class="stage" id="stage">
    <canvas id="cv" width="1920" height="1000"></canvas>
    
    <!-- Thanh thÃ´ng bÃ¡o overlay trÃªn map -->
    <div class="notification-bar show" id="notificationBar">
      <div class="notification-icon" id="notificationIcon">â„¹ï¸</div>
      <div class="notification-text" id="gameNotificationText"></div>
      <!-- Close button hidden to keep notification always visible -->
      <button class="notification-close" id="notificationClose" style="display: none;">Ã—</button>
    </div>

    <!-- Game HUB overlay dÆ°á»›i map -->
    <div class="game-hub" id="gameHub">
      <div class="hub-section hub-stats">
        <div class="hub-item">
          <div class="hub-icon">ğŸ</div>
          <div class="hub-label">Ngá»±a</div>
          <div class="hub-value" id="horsesCount">0</div>
        </div>
        <div class="hub-item">
          <div class="hub-icon">ğŸ¥•</div>
          <div class="hub-label">CÃ  rá»‘t</div>
          <div class="hub-value" id="carrotActive">A</div>
        </div>
        <div class="hub-item">
          <div class="hub-icon">â±</div>
          <div class="hub-label">Thá»i gian</div>
          <div class="hub-value" id="timer">0.00</div>
        </div>
        <div class="hub-item">
          <div class="hub-icon">ğŸ¯</div>
          <div class="hub-label">FPS</div>
          <div class="hub-value" id="fpsHud">0</div>
        </div>
      </div>
      
      <div class="hub-section hub-controls">
        <div class="hub-speed-control">
          <div class="hub-speed-label">âš¡ Tá»‘c Ä‘á»™</div>
          <div class="hub-speed-slider" id="speedSlider">
            <div class="speed-val" id="speedVal"></div>
            <div class="speed-thumb" id="speedThumb"></div>
          </div>
          <div class="hub-speed-value" id="speedLiveVal">1.0Ã—</div>
        </div>
        
        <div class="hub-physics-control">
          <label class="hub-toggle-label">
            <input type="checkbox" id="preventCollisionSpeedChange" class="hub-toggle">
            <span class="hub-toggle-slider"></span>
            <span class="hub-toggle-text">ğŸ›¡ï¸ NgÄƒn va cháº¡m thay Ä‘á»•i tá»‘c Ä‘á»™</span>
          </label>
        </div>
      </div>
      
      <div class="hub-section hub-actions">
        <button class="hub-btn primary" id="hudPlayTest" title="Cháº¡y thá»­ (F1)">
          <span class="btn-icon">â–¶</span>
          <span class="btn-text">Cháº¡y thá»­</span>
        </button>
        <button class="hub-btn secondary" id="openEditorBtn" title="Má»Ÿ Map Editor" style="display:none">
          <span class="btn-icon">âœ</span>
          <span class="btn-text">Editor</span>
        </button>
        <button class="hub-btn warning" id="pauseBtnHUD" title="Táº¡m dá»«ng / Tiáº¿p tá»¥c" style="display:none">
          <span class="btn-icon">â¸ï¸</span>
          <span class="btn-text">Dá»«ng</span>
        </button>
        <button class="hub-btn danger" id="toEditor" style="display:none">
          <span class="btn-icon">â¹</span>
          <span class="btn-text">Dá»«ng & Sá»­a</span>
        </button>
        <!-- Dev Mode Toggle -->
        <button class="hub-btn" id="devModeToggle" title="Dev Mode - Äiá»u khiá»ƒn ngá»±a (F3)" style="background: linear-gradient(135deg, #9c27b0, #673ab7);">
          <span class="btn-icon">ğŸ®</span>
          <span class="btn-text">Dev Mode</span>
        </button>
        <!-- Fullscreen Toggle -->
        <button class="hub-btn" id="fullscreenToggle" title="ToÃ n mÃ n hÃ¬nh (F11)" style="background: linear-gradient(135deg, #00897b, #00695c);">
          <span class="btn-icon">â›¶</span>
          <span class="btn-text">Full</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Results Overlay -->
  <div id="resultsOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#0f1417; border:1px solid #24323b; border-radius:10px; padding:16px 18px; width:min(420px, 92%); color:#e6edf3; box-shadow:0 10px 30px rgba(0,0,0,0.45);">
      <div style="font-weight:700; font-size:18px; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
        ğŸ Káº¿t quáº£
      </div>
      <div id="resultsBody" style="font-size:15px; line-height:1.6; margin-bottom:12px;">
        <!-- Filled by JS -->
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="playAgain                                                                                                                                                                             Btn">â–¶ ChÆ¡i láº¡i</button>
        <button class="btn secondary" id="closeResultsBtn">ÄÃ³ng</button>
      </div>
    </div>
  </div>
</div>

<!-- Dev Mode Controls Overlay -->
<div id="devModeControls" style="position: fixed; top: 20px; right: 20px; background: rgba(156, 39, 176, 0.95); color: white; padding: 15px; border-radius: 10px; font-family: 'Segoe UI', Arial, sans-serif; display: none; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
  <div style="font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
    ğŸ® Dev Mode Active
    <button id="devModeClose" style="background: none; border: none; color: white; font-size: 16px; cursor: pointer; margin-left: auto;">Ã—</button>
  </div>
  <div style="font-size: 12px; line-height: 1.4;">
    <div><strong>Controls:</strong></div>
    <div>ğŸ”¼ W/â†‘ - TÄƒng tá»‘c</div>
    <div>ğŸ”½ S/â†“ - Giáº£m tá»‘c</div>
    <div>â—€ï¸ A/â† - Ráº½ trÃ¡i</div>
    <div>â–¶ï¸ D/â†’ - Ráº½ pháº£i</div>
    <div>ğŸš€ Space - Skill (khi ready)</div>
    <div>ğŸ¯ Tab - Chuyá»ƒn ngá»±a</div>
    <div>ğŸ”„ F5 - Refresh horses</div>
    <div>ğŸ› Console: DevMode.debugHorses()</div>
    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
        <span>Ngá»±a:</span>
        <select id="playerHorseSelect" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 4px; border-radius: 3px; font-size: 11px;">
          <option value="0">#1</option>
        </select>
        <span id="playerHorseName" style="font-weight: bold;">#1</span>
        <button id="refreshHorses" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; cursor: pointer;">ğŸ”„</button>
      </div>
      <div id="playerHorseSkill">Skill: <span id="playerSkillStatus">Ready</span></div>
    </div>
  </div>
</div>

<!-- FPS moved into HUD -->


<!-- Modern Map Editor -->
<div class="rightbar" id="editorBar">
  <div class="grip-l" id="gripL" title="KÃ©o Ä‘á»ƒ chá»‰nh rá»™ng"></div>
  <div class="grip-br" id="gripBR" title="KÃ©o Ä‘á»ƒ Ä‘á»•i kÃ­ch thÆ°á»›c"></div>
  <div class="grip-bl" id="gripBL" title="KÃ©o Ä‘á»ƒ Ä‘á»•i kÃ­ch thÆ°á»›c"></div>
  <div class="grip-tr" id="gripTR" title="KÃ©o Ä‘á»ƒ Ä‘á»•i kÃ­ch thÆ°á»›c"></div>
  <div class="grip-tl" id="gripTL" title="KÃ©o Ä‘á»ƒ Ä‘á»•i kÃ­ch thÆ°á»›c"></div>
  
  <div class="editor-header" id="editorHeader">
    <div class="editor-title-section">
      <h2>ğŸ¨ Map Editor</h2>
      <div class="drag-handle" id="dragHandle" title="KÃ©o Ä‘á»ƒ di chuyá»ƒn panel">â‹®â‹®</div>
    </div>
    <div class="editor-controls">
      <div class="top-actions" style="display:flex; gap:8px; align-items:center; margin-right:8px;">
        <button class="btn" id="playBtn" title="Start Race (F1)">â–¶</button>
        <button class="btn" id="editBtn" title="Map Editor (F2)">âœ</button>
        <button class="btn" id="languageToggleBtn" title="Switch Language / Äá»•i NgÃ´n Ngá»¯">ğŸŒ</button>
        <button class="btn" id="focusBtn" title="Focus Mode" style="display: none;">ğŸ“º</button>
      </div>
      <div class="theme-controls" title="Editor Theme">
        <button class="theme-btn active" id="themeProfessional" title="Dark Professional">ğŸŒ™</button>
        <button class="theme-btn" id="themeModern" title="Modern Dark">ğŸ–¤</button>
        <button class="theme-btn" id="themeWarm" title="Warm Dark">ğŸ”¥</button>
        <button class="theme-btn" id="themeGaming" title="Gaming Style">ğŸ®</button>
      </div>
      <div class="position-controls" title="Vá»‹ trÃ­ panel">
        <button class="position-btn active" id="posRight" title="BÃªn pháº£i">â†’</button>
        <button class="position-btn" id="posLeft" title="BÃªn trÃ¡i">â†</button>
        <button class="position-btn" id="posBottom" title="DÆ°á»›i cÃ¹ng">â†“</button>
      </div>
      <button class="reset-view-btn" id="resetViewBtn" title="Reset view (Ctrl+0)">ğŸ”„</button>
    </div>
  </div>

  <div class="editor-content">
    <!-- Drawing Tools Section -->
    <div class="section">
      <div class="section-title">ğŸ› ï¸ Tools</div>
      
      <!-- Essential Tools -->
      <div class="tool-category">
        <div class="category-header" data-i18n="cat_essential">ğŸ¯ Essential</div>
        <div class="tools compact">
          <div class="tool active" data-tool="select" title="Select & Move">ğŸ¯</div>
          <div class="tool" data-tool="erase" title="Delete Objects">ğŸ—‘ï¸</div>
          <div class="tool" data-tool="wall" title="Draw Walls">ğŸ§±</div>
          <div class="tool" data-tool="brush" title="Brush Walls">ğŸ–Œï¸</div>
        </div>
      </div>

      <!-- Geometry Tools -->
      <div class="tool-category">
        <div class="category-header" data-i18n="cat_geometry">ğŸ“ Geometry</div>
        <div class="tools compact">
          <div class="tool" data-tool="diag" title="Diagonal Walls">ğŸ“</div>
          <div class="tool" data-tool="semi" title="Half-Circle">ğŸŒ™</div>
          <div class="tool" data-tool="arc" title="Arc Walls">ğŸŒˆ</div>
          <div class="tool" data-tool="text" title="Text Walls">ğŸ”¤</div>
          <div class="tool" data-tool="ebrush" title="Eraser Brush">ğŸ§¹</div>
          <div class="tool" data-tool="breakwall" title="Break Wall Brush">ğŸ’¥ğŸ§±</div>
          <div class="tool" data-tool="softwall" title="Soft Wall Brush">ğŸ§½ğŸ§±</div>
        </div>
      </div>

      <!-- Race Elements -->
      <div class="tool-category">
        <div class="category-header" data-i18n="cat_race">ğŸ Race Setup</div>
        <div class="tools compact">
          <div class="tool" data-tool="spawn" title="Horse Spawns">ğŸ</div>
          <div class="tool" data-tool="carrotA" title="Finish Line A">ğŸ¥•</div>
          <div class="tool" data-tool="carrotB" title="Finish Line B">ğŸ†</div>
          <div class="tool" data-tool="room" title="Waiting Room">ğŸ </div>
          <div class="tool" data-tool="start" title="Start Gate">ğŸš¦</div>
        </div>
      </div>

      <!-- Power-ups -->
      <div class="tool-category">
        <div class="category-header" data-i18n="cat_powerups">âš¡ Power-ups</div>
        <div class="tools compact">
          <div class="tool" data-tool="boost" title="Speed Boost">âš¡</div>
          <div class="tool" data-tool="turbo" title="Turbo">ğŸš€</div>
          <div class="tool" data-tool="ghost" title="Ghost Mode">ğŸ‘»</div>
          <div class="tool" data-tool="shield" title="Shield">ğŸ›¡ï¸</div>
          <div class="tool" data-tool="teleport" title="Teleport">ğŸŒ€</div>
          <div class="tool" data-tool="magnet" title="Magnet">ğŸ§²</div>
          <div class="tool" data-tool="timefreeze" title="Time Freeze">â„ï¸</div>
          <div class="tool" data-tool="icefreezer" title="Ice Freezer">ğŸ§Š</div>
          <div class="tool" data-tool="testpower" title="Testpower">âš¡</div><div class="tool" data-tool="poison" title="Poison">â˜ ï¸</div>
          <div class="tool" data-tool="fireaura" title="Fire Aura">ğŸ”¥</div>
          <div class="tool" data-tool="healingzone" title="Healing Zone">ğŸ’š</div><div class="tool" data-tool="tornado" title="Tornado Vortex">ğŸŒªï¸</div>
          <div class="tool" data-tool="volcano" title="Volcano">ğŸŒ‹</div>
          <div class="tool" data-tool="warpzone" title="Warp Zone">ğŸŒŒ</div>
          <div class="tool" data-tool="quantumdash" title="Quantum Dash">ğŸ”®</div><div class="tool" data-tool="yellowheart" title="Yellowheart">ğŸ’›</div><div class="tool" data-tool="nebula" title="Nebula">ğŸ”¹</div>
        </div>
      </div>

      <!-- Obstacles -->
      <div class="tool-category">
        <div class="category-header" data-i18n="cat_obstacles">ğŸš§ Obstacles</div>
        <div class="tools compact">
          <div class="tool" data-tool="ram" title="Ram Attack">ğŸ’¥</div>
          <div class="tool" data-tool="mud" title="Mud Patch">ğŸŸ¤</div>
          <div class="tool" data-tool="healingpatch" title="Healing Patch">ğŸ’–</div>
          <div class="tool" data-tool="rotbarrier" title="Rotating Barrier">âš–ï¸</div>
          <div class="tool" data-tool="firetrap" title="Fire Trap">â˜„ï¸</div>
          <div class="tool" data-tool="magnetpull" title="Magnetic Pull">ğŸ§¿</div>
        <div class="tool" data-tool="magnetpush" title="Magnetic Push">âœ¨</div>
          <div class="tool" data-tool="bumper" title="Bumper">ğŸŸ¦</div>
          <div class="tool" data-tool="spinner" title="Spinner">ğŸ”„</div>
        </div>
      </div>

      <!-- Advanced -->
      <div class="tool-category">
        <div class="category-header" data-i18n="cat_advanced">ğŸ”§ Advanced</div>
        <div class="tools compact">
          <div class="tool" data-tool="belt" title="Conveyor Belt">ğŸ“¦</div>
          <div class="tool" data-tool="fan" title="Wind Fan">ğŸ’«</div>
          <div class="tool" data-tool="weather" title="Weather System">ğŸŒ¦ï¸</div>
          <div class="tool" data-tool="oneway" title="One-way Gate">â›©ï¸</div>
          <div class="tool" data-tool="pad" title="Landing Pad">ğŸŸ©</div>
        </div>
      </div>
      
      <div class="row"><label data-i18n="color">ğŸ¨ Color</label><input type="color" id="shapeColor" value="#607d8b"/></div>
    </div>

    <!-- Settings Section -->
    <div class="section">
      <div class="section-title" data-i18n="settings">âš™ï¸ Settings</div>
      
      <!-- Language Settings -->
      <div class="setting-group">
        <div class="group-title" data-i18n="language">ğŸŒ Language</div>
        <div class="row compact" style="margin-bottom: 4px;">
          <select id="languageSelect" style="width: 100%; padding: 4px; border-radius: 4px; background: #2d3a4a; color: #eee; border: 1px solid #4a5a6a;">
            <option value="en">English</option>
            <option value="vi">Tiáº¿ng Viá»‡t</option>
          </select>
        </div>
      </div>
      
      <!-- Grid Settings -->
      <div class="setting-group">
        <div class="group-title" data-i18n="grid">ğŸ“ Grid</div>
        <div class="row compact"><label data-i18n="grid_size">Size</label><input id="grid" type="range" min="8" max="60" step="2" value="20" /><span id="gridVal">20px</span></div>
        <div class="row compact" style="align-items:center; gap:8px">
          <label for="hideGridOnPlay" data-i18n="hide_in_play">Hide in Play</label>
          <input id="hideGridOnPlay" type="checkbox" />
        </div>
      </div>

      <!-- Object Settings -->
      <div class="setting-group">
        <div class="group-title" data-i18n="cat_objects"> Objects</div>
        <div class="row compact"><label data-i18n="horse_speed"> Horse Speed</label><input id="speed" type="range" min="0.5" max="30" step="0.1" value="1.0" /><span id="speedValEditor">1.0Ã—</span></div>
        <div class="row compact"><label data-i18n="max_horse_speed"> Max Horse Speed</label><input id="maxHorseSpeed" type="range" min="0.5" max="30" step="0.1" value="30.0" /><span id="maxHorseSpeedVal">30.0Ã—</span></div>
        <div class="row compact"><label data-i18n="horse_radius"> Horse Radius</label><input id="horseRadius" type="range" min="8" max="60" step="1" value="36" /><span id="horseRadiusVal">36</span></div>
        <div class="row compact"><label data-i18n="carrot_size"> Carrot</label><input id="carrotRadius" type="range" min="8" max="60" step="1" value="30" /><span id="carrotRadiusVal">30</span></div>
        <div class="row compact"><label data-i18n="corner_radius"> Corner</label><input id="radius" type="range" min="6" max="30" step="2" value="14" /><span id="radiusVal">14</span></div>
      </div>

      <!-- Wall Settings -->
      <div class="setting-group">
        <div class="group-title" data-i18n="cat_walls"> Walls</div>
        <div class="row compact"><label data-i18n="wall_width">Width</label><input id="thick" type="range" min="6" max="80" step="2" value="24" /><span id="thickVal">24px</span></div>
        <div class="row compact" style="align-items:center; gap:8px">
          <label for="roundCap" data-i18n="round_cap">Round Cap</label>
          <input id="roundCap" type="checkbox" checked />
        </div>
        <div class="row compact"><label data-i18n="arc_span">ğŸŒˆ Arc Span</label><input id="arcSpan" type="range" min="30" max="330" step="5" value="180" /><span id="arcSpanVal">180Â°</span></div>
        <div class="row compact"><label data-i18n="brush_step">ğŸ–Œï¸ Brush Step</label><input id="brushStep" type="range" min="2" max="16" step="1" value="6" /><span id="brushStepVal">6px</span></div>
        <div class="row compact"><label data-i18n="break_hp">ğŸ’¥ Break HP</label><input id="breakHp" type="range" min="1" max="50" step="1" value="8" /><span id="breakHpVal">8</span></div>
        <div class="row compact"><label data-i18n="on_break">ğŸ’¥ On Break</label>
          <select id="breakOn">
            <option value="remove">Remove</option>
            <option value="shards" selected>Shards</option>
          </select>
        </div>
        <div class="row compact"><label data-i18n="soft_stiffness">ğŸ§½ Soft Stiffness</label><input id="softStiff" type="range" min="0.05" max="10" step="0.05" value="0.5" /><span id="softStiffVal">0.25</span></div>
        <div class="row compact"><label data-i18n="soft_max_def">ğŸ§½ Max Deform</label><input id="softMaxDef" type="range" min="0" max="100" step="1" value="18" /><span id="softMaxDefVal">18px</span></div>
        <div class="row compact"><label data-i18n="soft_recover">ğŸ§½ Recovery</label><input id="softRecover" type="range" min="0" max="120" step="2" value="24" /><span id="softRecoverVal">24px/s</span></div>
      </div>

      <!-- Special Settings -->
      <div class="setting-group">
        <div class="group-title" data-i18n="cat_special">ğŸ”§ Special</div>
        <div class="row compact"><label data-i18n="spinner_speed">ğŸ”„ Spinner Speed</label><input id="spinnerSpeed" type="range" min="0.1" max="5" step="0.1" value="1.0" /><span id="spinnerSpeedVal">1.0</span></div>
        <div class="row compact"><label data-i18n="spinner_length">ğŸ“ Spinner Length</label><input id="spinnerLength" type="range" min="20" max="240" step="5" value="80" /><span id="spinnerLengthVal">80px</span></div>
        <div class="row compact"><label data-i18n="mud_slowdown">ğŸŸ¤ Mud Slowdown</label><input id="mudSlowdown" type="range" min="0.1" max="0.9" step="0.05" value="0.4" /><span id="mudSlowdownVal">60%</span></div>
      </div>
      
      <!-- Magnet Settings -->
      <div class="setting-group">
        <div class="group-title" data-i18n="cat_magnet">ğŸ§² Magnet</div>
        <div class="row compact">
          <label data-i18n="magnet_range">Range</label>
          <input id="magnetRange" type="range" min="50" max="400" step="10" value="100" />
          <span id="magnetRangeVal">100px</span>
        </div>
        <div class="row compact">
          <label data-i18n="magnet_duration">Duration</label>
          <input id="magnetDuration" type="range" min="1000" max="10000" step="500" value="3000" />
          <span id="magnetDurationVal">3000 ms</span>
        </div>
        <div class="row compact">
          <label data-i18n="magnet_power">Power</label>
          <input id="magnetPower" type="range" min="100" max="1000" step="10" value="200" />
          <span id="magnetPowerVal">200</span>
        </div>
        <div class="row compact" style="align-items:center; gap:8px">
          <label data-i18n="magnet_attract_all">Attract All</label>
          <input id="magnetAttractAll" type="checkbox" />
        </div>
      </div>

      <!-- Context Inspector Popup (Global Quick-Access) -->
      <div id="contextInspector" style="position:absolute; display:none; z-index:9999; min-width:220px; max-width:280px; background:#1e2833; color:#e0f2f1; border:1px solid #3a4a5a; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.35); padding:10px;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
          <div style="font-weight:600;" data-i18n="context_title">âš™ï¸ Context Settings</div>
          <button id="contextClose" class="btn" style="padding:2px 6px;">âœ•</button>
        </div>
        <div id="contextBody">
          <!-- Filled dynamically per target -->
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="contextApply" class="btn" data-i18n="btn_apply">Apply</button>
        </div>
      </div>
      <div class="control-row" id="spinnerAngleControl" style="display: none;">
        <label data-i18n="label_spinner_angle">ğŸ§­ Spinner Angle</label>
        <input type="range" id="spinnerAngle" min="0" max="359" value="0" step="1">
        <span id="spinnerAngleVal">0Â°</span>
      </div>
      <!-- Bumper Inspector (shown when tool or selection is bumper) -->
      <div class="section" id="bumperInspector" style="display: none; margin-top:8px;">
        <div class="section-title" data-i18n="cat_bumper">ğŸŸ¦ Bumper</div>
        <div class="row"><label data-i18n="bumper_radius">ğŸ”˜ Radius</label><input id="bumperRadius" type="range" min="6" max="80" step="1" value="22" /><span id="bumperRadiusVal">22</span></div>
        <div class="row"><label data-i18n="bumper_elasticity">ğŸª— Elasticity</label><input id="bumperElasticity" type="range" min="0.5" max="2.5" step="0.01" value="1.15" /><span id="bumperElasticityVal">1.15</span></div>
        <div class="row"><label data-i18n="bumper_noise">ğŸŒ«ï¸ Angle Noise</label><input id="bumperNoise" type="range" min="0" max="0.7" step="0.01" value="0.15" /><span id="bumperNoiseVal">0.15</span></div>
        <div class="row"><label data-i18n="bumper_color">ğŸ¨ Bumper Color</label><input type="color" id="bumperColor" value="#7cf1ff"/></div>
      </div>

      <!-- Fan Inspector (shown when tool or selection is fan) -->
      <div class="section" id="fanInspector" style="display: none; margin-top:8px;">
        <div class="section-title" data-i18n="cat_fan">ğŸŒ€ Fan</div>
        <div class="row"><label data-i18n="fan_radius">ğŸ”˜ Radius</label><input id="fanRadius" type="range" min="20" max="300" step="1" value="120" /><span id="fanRadiusVal">120</span></div>
        <div class="row"><label data-i18n="fan_angle">ğŸ“ Angle</label><input id="fanAngle" type="range" min="0" max="359" step="1" value="0" /><span id="fanAngleVal">0Â°</span></div>
        <div class="row"><label data-i18n="fan_spread">ğŸ• Spread</label><input id="fanSpread" type="range" min="10" max="180" step="1" value="60" /><span id="fanSpreadVal">60Â°</span></div>
        <div class="row"><label data-i18n="fan_strength">ğŸ’¨ Strength</label><input id="fanStrength" type="range" min="0" max="0.3" step="0.005" value="0.08" /><span id="fanStrengthVal">0.08</span></div>
      </div>
    </div>

    <!-- Spawn Settings Section -->
    <div class="section">
      <div class="section-title" data-i18n="cat_spawn">ğŸ Spawn Settings</div>
      <div class="row"><label data-i18n="spawn_preset">ğŸ“‹ Spawn Preset</label><select id="spawnPreset"><option value="auto">Auto Grid</option><option value="line">Line</option><option value="grid2">Grid 2Ã—</option><option value="fan">Fan/Arc</option><option value="scatter">Scatter</option></select></div>
      <div class="row"><label data-i18n="spawn_jitter">ğŸ² Spawn Jitter</label><input id="spawnJitter" type="range" min="0" max="16" step="1" value="6" /><span id="spawnJitterVal">6px</span></div>
      <div class="row"><label data-i18n="start_bias">â±ï¸ Start Bias</label><input id="startBias" type="range" min="0" max="1500" step="50" value="100" /><span id="startBiasVal">100ms</span></div>
    </div>

    <!-- Game Items Section -->
    <div class="section">
      <div class="section-title" data-i18n="cat_game_items">ğŸ® Game Items</div>
      <div class="row">
        <label>ğŸ¥• Carrot A</label>
        <input type="checkbox" id="carrotAOn" />
        <span class="sw" style="background:linear-gradient(45deg, #ff9800, #ffc107)" title="Carrot A"></span>
      </div>
      <div class="row">
        <label>ğŸ¥• Carrot B</label>
        <input type="checkbox" id="carrotBOn" />
        <span class="sw" style="background:linear-gradient(45deg, #ff5722, #e91e63)" title="Carrot B"></span>
      </div>
    </div>

    <!-- Game Settings Section -->
    <div class="section">
      <div class="section-title" data-i18n="cat_game_settings">ğŸ® Game Settings</div>
      <div class="row"><label data-i18n="num_horses">ğŸ Horses (1-50)</label><input id="n" type="range" min="1" max="50" step="1" value="8" /><span id="nVal">8</span></div>
      <div class="row"><label data-i18n="game_speed">âš¡ Speed (0.1-5)</label><input id="runtimeSpeedSlider" type="range" min="0.1" max="5" step="0.1" value="1.0" /><span id="runtimeSpeedVal">1.0Ã—</span></div>
      <div class="row"><label data-i18n="countdown">â±ï¸ Countdown (s)</label><input id="countdownSlider" type="range" min="0" max="10" step="1" value="0" /><span id="countdownVal">0s</span></div>
      <div class="row">
        <label data-i18n="collision_sfx">ğŸ”Š Collision SFX</label>
        <input type="checkbox" id="collisionSfx" checked />
        <span class="sw" style="background:linear-gradient(45deg, #4caf50, #8bc34a)" title="Sound Effects"></span>
      </div>
      <div class="row">
        <label data-i18n="trail_effect">ğŸ’¨ Horse Trail Effect</label>
        <input type="checkbox" id="trailEnabled" />
        <input type="color" id="trailColor" value="#9e9e9e" title="Trail color" style="margin-left:8px" />
      </div>
      <div class="row">
        <label data-i18n="trail_intensity">ğŸ’¨ Trail Intensity</label>
        <input id="trailIntensity" type="range" min="0" max="1.6" step="0.05" value="1.0" />
        <span id="trailIntensityVal">1.00Ã—</span>
      </div>
      <div class="row">
        <label data-i18n="hide_all_names">ğŸ™ˆ Hide All Names</label>
        <input type="checkbox" id="hideHorseNames" />
      </div>
      <div class="row"><label data-i18n="name_size">ğŸ”¤ Name Size</label>
        <input id="nameFontScale" type="range" min="0.5" max="2.0" step="0.05" value="0.55" />
        <span id="nameFontScaleVal">0.55Ã—</span>
      </div>
      
      <!-- HP System Settings -->
      <div class="row">
        <label data-i18n="enable_hp_system">â¤ï¸ Enable HP System</label>
        <input type="checkbox" id="hpSystemEnabled" />
        <span class="sw" style="background:linear-gradient(45deg, #f44336, #e91e63)" title="HP Combat System"></span>
      </div>
      <div class="row">
        <label data-i18n="horse_max_hp">ğŸ’– Horse Max HP</label>
        <input id="horseMaxHP" type="number" min="1" max="9999" step="1" value="100" />
        <span id="horseMaxHPVal">100</span>
      </div>
      <div class="row">
        <label data-i18n="show_hp_numbers">ğŸ”¢ Show HP Numbers</label>
        <input type="checkbox" id="showHPNumbers" />
        <span class="sw" style="background:linear-gradient(45deg, #2196f3, #03a9f4)" title="Display HP Values"></span>
      </div>
      <div class="row">
        <label data-i18n="show_horse_speed">âš¡ Show Horse Speed</label>
        <input type="checkbox" id="showHorseSpeed" />
        <span class="sw" style="background:linear-gradient(45deg, #9c27b0, #ba68c8)" title="Display velocity below horses"></span>
      </div>
      <div class="row">
        <label data-i18n="auto_rotate_sprite">ğŸ”„ Auto Rotate Horse Sprite (Global)</label>
        <input type="checkbox" id="autoRotateHorseSprite" />
        <span class="sw" style="background:linear-gradient(45deg, #ff9800, #ffc107)" title="Automatically rotate all horse sprites based on movement direction"></span>
      </div>
      <div class="row">
        <label data-i18n="last_horse_wins">ğŸ‘‘ Last Horse Standing Wins</label>
        <input type="checkbox" id="lastHorseWins" />
        <span class="sw" style="background:linear-gradient(45deg, #ff9800, #ffc107)" title="Win by elimination instead of finish line"></span>
      </div>
      <div class="row">
        <label data-i18n="wall_damage">ğŸ§± Wall Damage</label>
        <input type="checkbox" id="wallDamageEnabled" />
        <span class="sw" style="background:linear-gradient(45deg, #795548, #8d6e63)" title="Wall Collision Damage"></span>
      </div>
      <div class="row">
        <label data-i18n="border_damage">ğŸ”² Border Damage</label>
        <input type="checkbox" id="borderDamageEnabled" />
        <span class="sw" style="background:linear-gradient(45deg, #607d8b, #78909c)" title="Screen Border Damage"></span>
      </div>
      <div class="row">
        <label data-i18n="wall_damage_amount">ğŸ’¥ Wall Damage Amount</label>
        <input id="wallDamageAmount" type="range" min="1" max="50" step="1" value="10" />
        <span id="wallDamageAmountVal">10</span>
      </div>
      <div class="row">
        <label data-i18n="border_damage_amount">ğŸ”¥ Border Damage Amount</label>
        <input id="borderDamageAmount" type="range" min="1" max="50" step="1" value="15" />
        <span id="borderDamageAmountVal">15</span>
      </div>
      <div class="row"><label data-i18n="min_cruise">ğŸï¸ Min Cruise</label><input id="minCruise" type="range" min="0" max="15" step="0.1" value="1.5" /><span id="minCruiseVal">1.5</span></div>
      <div class="row">
        <label data-i18n="luck_or_suck">ğŸ€ Luck or Suck</label>
        <input type="checkbox" id="luckEnabled" />
      </div>
      <div class="row">
        <label data-i18n="luck_interval">â²ï¸ Luck Interval (s)</label>
        <input id="luckInterval" type="number" min="3" max="60" step="1" value="12" />
      </div>
<div style="margin-top:16px">
        <button class="btn" id="testRace" data-i18n="test_race_btn">â–¶ Test Race</button>
      </div>
    </div>

    <!-- Map Management Section -->
    <div class="section">
      <div class="panel-section" id="audio-panel">
        <div class="panel-title" data-i18n="panel_bgm">ğŸµ Background Music</div>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 12px;align-items:center;">
            <label for="bgmFile" data-i18n="label_bgm_file">Music File:</label>
            <input type="file" id="bgmFile" accept="audio/*" class="btn secondary" style="width:100%;">
            <label data-i18n="label_controls">Controls:</label>
            <div style="display:flex; gap: 8px; align-items: center;">
                <button class="btn" id="bgmPause" style="width: 44px; height: 36px; padding: 0;">â¸ï¸</button>
                <input type="range" id="bgmVolume" min="0" max="1" step="0.05" value="0.5" style="flex-grow: 1;">
            </div>
            <label for="ttsVoiceSel" data-i18n="label_tts_voice">TTS Voice:</label>
            <select id="ttsVoiceSel" title="Select TTS Voice" style="width:100%;"></select>
            <label for="ttsEnabled" data-i18n="label_tts_enabled">Enable TTS:</label>
            <input type="checkbox" id="ttsEnabled" />
            <!-- Azure TTS controls are hidden for a simpler setup -->
            <label for="ttsSourceSel" style="display:none" data-i18n="label_tts_source">TTS Source:</label>
            <select id="ttsSourceSel" title="Select TTS Source" style="width:100%; display:none">
              <option value="browser">Browser</option>
              <option value="azure">Azure (Cloud)</option>
            </select>
            <div id="ttsAzureCfg" style="display:none; grid-column: 1 / span 2; gap:8px;">
              <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 12px;align-items:center;">
                <label for="ttsAzureKey" data-i18n="label_azure_key">Azure Key:</label>                                                                                                                                                                                                      
                <input type="password" id="ttsAzureKey" placeholder="API Key" style="width:100%" />
                <label for="ttsAzureRegion" data-i18n="label_azure_region">Region:</label>
                <input type="text" id="ttsAzureRegion" placeholder="e.g. southeastasia" style="width:100%" />
                <label for="ttsAzureVoice" data-i18n="label_azure_voice">Azure Voice:</label>
                <input type="text" id="ttsAzureVoice" placeholder="vi-VN-HoaiMyNeural" style="width:100%" />
              </div>
            </div>
            <div style="grid-column: 1 / span 2; display:flex; gap:8px; margin-top:6px;">
              <button class="btn secondary" id="testTts" data-i18n="test_tts_btn">ğŸ”Š Test TTS</button>
              <small style="opacity:.8; align-self:center;" data-i18n="test_tts_hint">Plays: "Hello!"</small>
            </div>
        </div>
      </div>

      <div class="panel-section" id="map-management-panel">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <button class="btn" id="clearMap" data-i18n="btn_clear_map">ğŸ—‘ï¸ Clear Map</button>
        <button class="btn secondary" id="loadSample" data-i18n="btn_load_sample">ğŸ“‹ Load Sample</button>
        <button class="btn" id="randomMap" data-i18n="btn_generate_map">ğŸ² Generate Map</button>
        <button class="btn" id="randomItems" data-i18n="btn_add_items">âœ¨ Add Items</button>
        <button class="btn" id="addBelt" data-i18n="btn_add_belt">â• Add Belt</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <button class="btn secondary" id="exportMap" data-i18n="btn_export_json">ğŸ“¤ Export JSON</button>
        <button class="btn secondary" id="importMap" data-i18n="btn_import_json">ğŸ“¥ Import JSON</button>
      </div>
    </div>
    <!-- Preset Maps Quick Select -->
    <div class="section">
      <div class="section-title" data-i18n="cat_preset_maps">ğŸ—ºï¸ Preset Maps</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px;">
        <button class="btn" id="preset1" data-i18n="btn_preset_oval">ğŸ Oval</button>
        <button class="btn" id="preset2" data-i18n="btn_preset_spinner">ğŸŒªï¸ Spinner</button>
        <button class="btn" id="preset3" data-i18n="btn_preset_maze">ğŸ§± Maze</button>
      </div>
    </div>
    <!-- Waiting Room Settings -->
    <div class="section">
      <div class="section-title" data-i18n="cat_waiting_room">ğŸšª Waiting Room</div>
      <div class="row"><label data-i18n="wr_width">ğŸ“ Width</label><input id="waitingRoomW" type="number" min="160" max="1200" step="10" value="260"/></div>
      <div class="row"><label data-i18n="wr_height">ğŸ“ Height</label><input id="waitingRoomH" type="number" min="160" max="1200" step="10" value="480"/></div>
      <div class="row"><label data-i18n="wr_corner_radius">â¬œ Corner Radius</label><input id="waitingRoomR" type="number" min="0" max="60" step="1" value="18"/></div>
      <div class="row"><label data-i18n="wr_auto_fit">âš™ï¸ Auto-fit at race start</label><input id="autoFitWaitingRoom" type="checkbox" checked/></div>
    </div>
    <!-- Advanced Carrot Customization Section -->
    <div class="section">
      <div class="section-title" data-i18n="cat_carrot_settings">ğŸ¥• Advanced Carrot Settings</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <button class="btn secondary" id="swapCarrots" data-i18n="btn_swap_ab">ğŸ”„ Swap A/B</button>
        <button class="btn secondary" id="resetCarrots" data-i18n="btn_reset_pos">ğŸ¯ Reset Positions</button>
      </div>
      <div class="row">
        <label data-i18n="label_png_sprite">ğŸ–¼ï¸ PNG Sprite</label>
        <input id="carrotSpriteFile" type="file" accept="image/png"/>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <button class="btn secondary" id="clearCarrotSpriteA" data-i18n="btn_clear_a">ğŸ—‘ï¸ Clear A</button>
        <button class="btn secondary" id="clearCarrotSpriteB" data-i18n="btn_clear_b">ğŸ—‘ï¸ Clear B</button>
      </div>
      <div class="row"><label data-i18n="label_sprite_scale">ğŸ“ Sprite Scale</label><input id="carrotSpriteScale" type="range" min="0.5" max="2.5" step="0.05" value="1.0"/><span id="carrotSpriteScaleVal">1.0Ã—</span></div>
      <div class="row"><label data-i18n="label_sprite_outline">ğŸ–Œï¸ Sprite Outline</label><select id="carrotSpriteOutline"><option value="off">Off</option><option value="on">On</option></select></div>
      <div class="row"><label data-i18n="label_outline_color">ğŸ¨ Outline Color</label><input id="carrotSpriteOutlineColor" type="color" value="#FFFFFF"/></div>
      <div class="row"><label data-i18n="label_outline_width">ğŸ“ Outline Width</label><input id="carrotSpriteOutlineWidth" type="range" min="1" max="8" step="1" value="2"/><span id="carrotSpriteOutlineWidthVal">2px</span></div>
    </div>

    <!-- Horse Customization Section -->
    <div class="section">
      <div class="section-title" data-i18n="cat_horse_custom">ğŸ´ Horse Customization</div>
      <div class="row">
        <label data-i18n="label_select_horse">ğŸ”¢ Select Horse #</label>
        <input id="horseIdx" type="number" min="1" max="50" value="1"/>
        <span class="chip">Max: Current Count</span>
      </div>
      <div class="row"><label data-i18n="label_display_name">ğŸ“ Display Name</label><input id="horseName" type="text" placeholder="e.g., Thunder Bolt"/></div>
      <div class="row"><label data-i18n="label_special_skill">âš¡ Special Skill</label><select id="horseSkill"><option value="none">None</option><option value="hunter">ğŸ¯ Hunter's Gambit</option><option value="guardian">ğŸ›¡ï¸ Divine Guardian</option><option value="phantom_strike">ğŸ‘» Phantom Strike</option><option value="cosmic_swap">ğŸ”€ Cosmic Swap</option><option value="chain_lightning">âš¡ Chain Lightning</option><option value="gravity_well">ğŸŒ€ Gravity Well</option><option value="chill_guy">ğŸ˜ Chill Guy</option><option value="overdrive">âš¡ Overdrive</option><option value="slipstream">ğŸ’¨ Slipstream</option><option value="shockwave">ğŸ’¥ Shockwave</option><option value="oguri_fat">ğŸ” Oguri Fat</option><option value="silence_shizuka">ğŸ¤« Silence Shizuka</option><option value="fireball">ğŸ”¥ Fireball</option><option value="energy_ball">âš¡ Energy Ball</option><option value="supersonic_speed">ğŸ’¨ Supersonic Speed</option><option value="meteor_strike">â˜„ï¸ Meteor Strike</option><option value="black_hole">ğŸ•³ï¸ Black Hole</option><option value="ice_age">â„ï¸ Ice Age</option><option value="mirror_image">ğŸª Mirror Image</option><option value="time_warp">â° Time Warp</option><option value="blink">âœ¨ Blink</option><option value="rocket_boost">ğŸš€ Rocket Boost</option><option value="gravity_flip">ğŸ”„ Gravity Flip</option><option value="phoenix_rebirth">ğŸ”¥ Phoenix Rebirth</option><option value="avatar_state">ğŸŒ€ Avatar State</option><option value="rainbow_trail">ğŸŒˆ Rainbow Trail</option><option value="disco_chaos">ğŸª© Disco Chaos</option><option value="aurora_shield">âœ¨ Aurora Shield</option></select></div>
      <div class="row" id="skillDescRow"><label></label><div id="skillDesc" style="background:rgba(33,150,243,0.15);padding:8px 12px;border-radius:6px;font-size:13px;color:#90caf9;border-left:3px solid #2196F3;">KhÃ´ng cÃ³ ká»¹ nÄƒng Ä‘áº·c biá»‡t</div></div>
      
      <!-- Individual Horse Stats -->
      <div class="row"><label data-i18n="label_custom_speed">ğŸƒ Custom Speed</label><input id="horseSpeed" type="number" min="0.1" max="5.0" step="0.1" placeholder="Default"/><span class="chip">Leave empty for default</span></div>
      <div class="row"><label data-i18n="label_custom_hp">â¤ï¸ Custom HP</label><input id="horseHP" type="number" min="1" max="500" step="1" placeholder="Default"/><span class="chip">Leave empty for default (100)</span></div>
      <div class="row"><label data-i18n="label_luck">ğŸ€ Luck</label><input id="horseLuck" type="number" min="0" max="100" step="0.1" placeholder="0"/><span class="chip">% chance to bypass cooldown</span></div>
      <div class="row"><label data-i18n="label_luck_int">â±ï¸ Luck Interval</label><input id="horseLuckInterval" type="number" min="0.1" max="60" step="0.1" placeholder="1"/><span class="chip">seconds (default: 1s)</span></div>
      
      <div class="row"><label data-i18n="label_body_color">ğŸ¨ Body Color</label><input id="colorBody" type="color" value="#42a5f5"/><span class="sw" id="swBody"></span></div>
      <div class="row"><label data-i18n="label_label_color">ğŸ·ï¸ Label Color</label><input id="colorLabel" type="color" value="#1e88e5"/><span class="sw" id="swLabel"></span></div>
      
      <div class="row"><label data-i18n="label_png_sprite">ğŸ–¼ï¸ PNG Sprite</label><input id="spriteFile" type="file" accept="image/png"/></div>
      <!-- Single button to open sprite preset picker -->
      <div class="row"><button class="btn secondary" id="openSpritePicker">ğŸ“š Sprite Presetsâ€¦</button></div>
      <!-- Modal Picker -->
      <div id="spritePickerModal" style="display:none;position:fixed;inset:0;z-index:1000;">
        <div id="spritePickerBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.45)"></div>
        <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#1e1e1e;border:1px solid #333;border-radius:12px;min-width:320px;max-width:80vw;max-height:80vh;box-shadow:0 10px 30px rgba(0,0,0,0.4);display:flex;flex-direction:column">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #333">
            <div style="font-weight:600">Sprite Presets</div>
            <button id="closeSpritePicker" class="btn secondary">âœ–</button>
          </div>
          <div style="padding:10px 12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;border-bottom:1px solid #333">
            <button class="btn" id="importSpriteFiles">â• Import PNGsâ€¦</button>
            <button class="btn secondary" id="importSpriteFolder">ğŸ“‚ Import Folderâ€¦</button>
            <span style="opacity:0.75;font-size:12px">Tip: You can also use built-ins below</span>
          </div>
          <div id="spritePickerGrid" style="padding:12px;overflow:auto;display:grid;grid-template-columns:repeat(4,112px);justify-content:center;gap:12px"></div>
        </div>
      </div>
      <div class="row"><label>ğŸ¥• Carrot PNG</label><input id="carrotSpriteFile" type="file" accept="image/png"/></div>
      <div class="row"><label>ğŸ“ Sprite Scale</label><input id="spriteScale" type="range" min="0.5" max="2.0" step="0.05" value="1.0"/><span id="spriteScaleVal">1.0Ã—</span></div>
      <div class="row"><label>ğŸ–Œï¸ Outline</label><select id="spriteOutline"><option value="off">Off</option><option value="on">On</option></select></div>
      <div class="row"><label>ğŸ¨ Outline Color</label><input id="spriteOutlineColor" type="color" value="#000000"/></div>
      <div class="row"><label>ğŸ“ Outline Width</label><input id="spriteOutlineWidth" type="range" min="1" max="6" step="1" value="2"/><span id="spriteOutlineWidthVal">2px</span></div>
      
      <!-- Action Groups -->
      <div class="action-groups">
        <!-- Current Horse Actions -->
        <div class="action-group">
          <div class="group-title" data-i18n="current_horse_group">ğŸ¯ Current Horse</div>
          <div class="action-grid">
            <button class="btn primary" id="applyHorse" data-i18n="btn_apply">âœ… Apply</button>
            <button class="btn secondary" id="resetHorse" data-i18n="btn_reset">ğŸ”„ Reset</button>
            <button class="btn secondary" id="randomHorse" data-i18n="btn_random">ğŸ² Random</button>
            <button class="btn secondary" id="randomSkill" data-i18n="btn_skill">ğŸ² Skill</button>
          </div>
        </div>

        <!-- All Horses Actions -->
        <div class="action-group">
          <div class="group-title" data-i18n="all_horses_group">ğŸ‘¥ All Horses</div>
          <div class="action-grid">
            <button class="btn secondary" id="copyAll" data-i18n="btn_copy_all">ğŸ“‹ Copy All</button>
            <button class="btn secondary" id="randomAllHorses" data-i18n="btn_random_all">ğŸ² Random All</button>
            <button class="btn secondary" id="randomSkillAll" data-i18n="btn_skill_all">ğŸ² Skill All</button>
            <button class="btn secondary" id="clearSprite" data-i18n="btn_clear">ğŸ—‘ï¸ Clear</button>
          </div>
        </div>

        <!-- Sprite Actions -->
        <div class="action-group">
          <div class="group-title" data-i18n="sprites_group">ğŸ–¼ï¸ Sprites</div>
          <div class="action-grid">
            <button class="btn secondary" id="randomSprite" data-i18n="btn_random_n">ğŸ² Random #N</button>
            <button class="btn secondary" id="randomSpriteAll" data-i18n="btn_random_all">ğŸ² Random All</button>
            <button class="btn secondary" id="copySpriteAll" data-i18n="btn_copy_all">ğŸ“‹ Copy All</button>
            <button class="btn secondary" id="copyOutlineAll" data-i18n="btn_outline_all">âœï¸ Outline All</button>
          </div>
        </div>

        <!-- Color & Skill Actions -->
        <div class="action-group">
          <div class="group-title" data-i18n="colors_skills_group">ğŸ¨ Colors & Skills</div>
          <div class="action-grid">
            <button class="btn secondary" id="copyBodyAll" data-i18n="btn_body_all">ğŸ¨ Body All</button>
            <button class="btn secondary" id="copySkillAll" data-i18n="btn_skill_all_2">ğŸ› ï¸ Skill All</button>
          </div>
        </div>
      </div>
    </div>
    <div class="hint">Hint: Sprite PNG ná»n trong suá»‘t sáº½ Ä‘áº¹p nháº¥t. Tá»‡p Ä‘Æ°á»£c lÆ°u local (Base64) khi Save/Export.</div>
  </div>
  <div class="row"><button class="btn" id="undo" data-i18n="btn_undo">Undo (recent shape)</button><button class="btn" id="clearWalls" data-i18n="btn_clear_walls">Clear ALL walls</button></div>
  <div class="row"><button class="btn" id="exportJson" data-i18n="btn_export_json">Export JSON</button><input id="importFile" type="file" accept=".json" /></div>
  <div class="row"><button class="btn" id="saveLS" data-i18n="btn_save_browser">Save to browser</button><button class="btn" id="loadLS" data-i18n="btn_load_browser">Load</button></div>
</div>

<!-- Toggle buttons -->

<div class="countdown" id="cd" style="display:none">Chuáº©n bá»‹...</div>


<!-- Load typedefs (JSDoc only, no runtime behavior) -->
<script src="scripts/types.js"></script>
<!-- App namespace (read-only proxies), safe & non-destructive -->
<script src="scripts/app.js"></script>
<!-- Load constants first -->
<script src="scripts/constants.js"></script>
<script src="scripts/data/horse-defaults.js"></script>
<script src="scripts/data/horse-initialization.js"></script>
<!-- Load new safety utilities (SAFE - pure functions, no side effects) -->
<script src="scripts/validators.js"></script>
<script src="scripts/safe-utils.js"></script>
<script src="scripts/dom-cache.js"></script>
<script src="scripts/utils/vector-drawing.js"></script>
<script src="scripts/utils/sprite-drawing.js"></script>
<script src="scripts/utils/drawing-effects.js"></script>
<script src="scripts/utils/drawing-helpers.js"></script>
<script src="scripts/utils/grid-drawing.js"></script>
<!-- Load spatial hash for optimized collision detection -->
<script src="scripts/spatial-hash.js"></script>
<!-- Load core modules -->
<script src="scripts/core/audio.js"></script>
<script src="scripts/core/geometry.js"></script>
<script src="scripts/core/weather.js"></script>
<script src="scripts/core/visual-effects.js"></script>
<script src="scripts/core/powerup-system.js"></script>
<!-- Load core constants first -->
<script src="scripts/core/constants.js"></script>
<script src="scripts/core/fps-monitor.js"></script>
<script src="scripts/core/performance-timing.js"></script>
<!-- Load UI modules -->
<script src="scripts/ui/theme.js"></script>
<script src="scripts/ui/notifications.js"></script>
<script src="scripts/ui/event-log.js"></script>
<script src="scripts/ui/hud.js?v=20251128"></script>
<script src="scripts/ui/flash.js"></script>
<script src="scripts/ui/hud-speed-slider.js"></script>
<script src="scripts/ui/focus-mode.js"></script>
<script src="scripts/ui/game-controls.js"></script>
<script src="scripts/ui/visibility-controls.js"></script>
<script src="scripts/ui/settings-controls.js"></script>
<script src="scripts/ui/button-tooltips.js"></script>
<script src="scripts/ui/results-overlay.js"></script>
<!-- horse-editor-buttons.js removed - keeping in extracted-inline.js for proper function access -->
<!-- Load extracted inline code (defines mapDef and other globals) -->
<script src="scripts/extracted-inline.js?v=20251128"></script>
<!-- Load sprite modules AFTER extracted-inline.js (they depend on ensureCustomIndex) -->
<script src="scripts/core/sprite-manager.js"></script>
<script src="scripts/core/carrot-sprite-manager.js"></script>
<!-- Load editor modules -->
<script src="scripts/editor/history.js"></script>
<script src="scripts/editor/stage-transform.js"></script>
<script src="scripts/editor/waiting-room-resize.js"></script>
<script src="scripts/editor/canvas-resize.js"></script>
<script src="scripts/editor/horse-editor-utils.js"></script>
<script src="scripts/editor/horse-customization-ui.js"></script>
<script src="scripts/editor/powerup-settings-init.js"></script>
<script src="scripts/editor/powerup-collision.js"></script>
<script src="scripts/rendering/powerup-rendering.js"></script>
<script src="scripts/editor/draggable-panel.js"></script>
<script src="scripts/editor/carrot-ui-controls.js"></script>
<script src="scripts/editor/text-walls.js"></script>
<script src="scripts/editor/editor-shortcuts.js"></script>
<!-- ui-initialization.js removed - keeping event handlers in extracted-inline.js for stability -->
<!-- Load race module AFTER mapDef is defined -->
<script src="scripts/core/race.js"></script>
<!-- app-initialization.js removed - keeping in extracted-inline.js for proper execution order -->
<!-- Load new modular scripts -->
<script src="scripts/config.js"></script>
<script src="scripts/utils.js"></script>
<script src="scripts/ui-handlers.js"></script>
<script src="scripts/game-logic.js"></script>
<!-- Load render module wrapper (non-destructive). Must come after all inline scripts -->
<script src="scripts/render.js"></script>
<!-- Load Dev Mode -->
<script src="scripts/dev-mode.js"></script>
<script src="scripts/dev-mode-integration.js"></script>
<!-- Load loading screen -->
  <script src="scripts/loading.js"></script>
  <script>
    // Auto-start loading screen when page loads
    document.addEventListener('DOMContentLoaded', () => {
      const loadingScreen = new LoadingScreen();
      
      // Detect if running in Electron or web browser
      const isElectron = !!(window.process && window.process.versions && window.process.versions.electron);
      
      if (isElectron) {
        // Electron: autoplay policy disabled, audio works immediately
        console.log('Running in Electron - audio enabled');
        loadingScreen.start();
      } else {
        // Web browser: need to handle autoplay policy
        console.log('Running in web browser - handling autoplay policy');
        
        // Show loading screen immediately
        loadingScreen.start();
        
        // Add click anywhere to enable audio
        const enableAudio = (e) => {
          console.log('User clicked - enabling audio');
          loadingScreen.playStartupSound();
          document.removeEventListener('click', enableAudio);
          document.removeEventListener('keydown', enableAudio);
          document.removeEventListener('touchstart', enableAudio);
        };
        
        document.addEventListener('click', enableAudio);
        document.addEventListener('keydown', enableAudio);
        document.addEventListener('touchstart', enableAudio);
        
        // Show instruction for web users
        setTimeout(() => {
          if (document.getElementById('loadingScreen').style.display !== 'none') {
            const instruction = document.createElement('div');
            instruction.id = 'audioInstruction';
            instruction.style.cssText = `
              position: fixed;
              bottom: 20px;
              left: 50%;
              transform: translateX(-50%);
              background: rgba(0,0,0,0.8);
              color: white;
              padding: 10px 20px;
              border-radius: 20px;
              font-size: 14px;
              z-index: 10001;
              animation: pulse 2s infinite;
            `;
            instruction.textContent = 'ğŸ”Š Click anywhere to enable sound';
            document.body.appendChild(instruction);
            
            // Remove instruction after audio is enabled
            document.addEventListener('click', () => {
              if (instruction.parentNode) {
                instruction.remove();
              }
            }, { once: true });
          }
        }, 1000);
      }
    });
  </script>

  <!-- Nebula Context Settings Panel - Auto-generated v6.0 -->
  <div id="nebulaContextPanel" class="context-panel" style="display: none;">
    <div class="context-header">
      <h3>ğŸŸ£ Nebula Settings</h3>
      <button class="context-close" onclick="hideContextPanel()">&times;</button>
    </div>
    
    <div class="context-content">
      
      <div class="context-setting" title="How fast the power-up effect makes the horse move">
        <label>Speed Multiplier: <span id="nebulaspeedMultiplierValue">2.5</span></label>
        <input type="range" id="nebulaspeedMultiplier" 
               min="0.1" max="5" step="0.1" 
               value="2.5"
               oninput="updateNebulaSetting('speedMultiplier', this.value)">
        <div class="range-labels">
          <span>0.1</span>
          <span>5</span>
        </div>
      </div>
      <div class="context-setting" title="How long the power-up effect lasts">
        <label>Duration (ms): <span id="nebuladurationMsValue">4000</span></label>
        <input type="range" id="nebuladurationMs" 
               min="500" max="15000" step="250" 
               value="4000"
               oninput="updateNebulaSetting('durationMs', this.value)">
        <div class="range-labels">
          <span>500</span>
          <span>15000</span>
        </div>
      </div>
      <div class="context-setting" title="Amount of damage dealt by this power-up">
        <label>Damage: <span id="nebuladamageValue">20</span></label>
        <input type="range" id="nebuladamage" 
               min="1" max="100" step="1" 
               value="20"
               oninput="updateNebulaSetting('damage', this.value)">
        <div class="range-labels">
          <span>1</span>
          <span>100</span>
        </div>
      </div>
      <div class="context-setting" title="Visual size of the power-up">
        <label>Size (radius): <span id="nebularadiusValue">16</span></label>
        <input type="range" id="nebularadius" 
               min="8" max="48" step="2" 
               value="16"
               oninput="updateNebulaSetting('radius', this.value)">
        <div class="range-labels">
          <span>8</span>
          <span>48</span>
        </div>
      </div>
      <div class="context-setting" title="Enable/disable particle visual effects">
        <label>
          <input type="checkbox" id="nebulaparticleEnabled" 
                 checked
                 onchange="updateNebulaSetting('particleEnabled', this.checked)">
          Particle Effects
        </label>
      </div>
      <div class="context-setting" title="Enable/disable glow visual effects">
        <label>
          <input type="checkbox" id="nebulaglowEnabled" 
                 checked
                 onchange="updateNebulaSetting('glowEnabled', this.checked)">
          Glow Effect
        </label>
      </div>
      <div class="context-setting" title="Intensity of visual and gameplay effects">
        <label>Effect Intensity: <span id="nebulaintensityValue">1</span></label>
        <input type="range" id="nebulaintensity" 
               min="0.1" max="3" step="0.1" 
               value="1"
               oninput="updateNebulaSetting('intensity', this.value)">
        <div class="range-labels">
          <span>0.1</span>
          <span>3</span>
        </div>
      </div>
      
      <div class="context-actions">
        <button class="btn btn-primary" onclick="applyNebulaSettings()">Apply</button>
        <button class="btn btn-secondary" onclick="resetNebulaSettings()">Reset to Defaults</button>
        <button class="btn btn-info" onclick="exportNebulaSettings()">Export Settings</button>
      </div>
      
      <div class="context-presets">
        <label>Quick Presets:</label>
        <div class="preset-buttons">
          <button onclick="loadNebulaPreset('weak')">Weak</button>
          <button onclick="loadNebulaPreset('normal')">Normal</button>
          <button onclick="loadNebulaPreset('strong')">Strong</button>
          <button onclick="loadNebulaPreset('extreme')">Extreme</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Context Panel Styles -->
  <style>
  .context-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #2d3748;
    border: 2px solid #4a5568;
    border-radius: 8px;
    padding: 0;
    min-width: 320px;
    max-width: 480px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    z-index: 10000;
    color: white;
    font-family: 'Segoe UI', sans-serif;
  }

  .context-header {
    background: #1a202c;
    padding: 15px 20px;
    border-bottom: 1px solid #4a5568;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .context-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }

  .context-close {
    background: none;
    border: none;
    color: #cbd5e0;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .context-close:hover {
    color: #f7fafc;
    background: #4a5568;
    border-radius: 4px;
  }

  .context-content {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
  }

  .context-setting {
    margin-bottom: 20px;
  }

  .context-setting label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 14px;
  }

  .context-setting input[type="range"] {
    width: 100%;
    margin: 8px 0;
  }

  .context-setting input[type="checkbox"] {
    margin-right: 8px;
  }

  .range-labels {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #a0aec0;
    margin-top: 4px;
  }

  .context-actions {
    margin-top: 30px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
  }

  .btn-primary { background: #3182ce; color: white; }
  .btn-primary:hover { background: #2c5aa0; }

  .btn-secondary { background: #4a5568; color: white; }
  .btn-secondary:hover { background: #2d3748; }

  .btn-info { background: #319795; color: white; }
  .btn-info:hover { background: #2c7a7b; }

  .context-presets {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #4a5568;
  }

  .context-presets label {
    display: block;
    margin-bottom: 10px;
    font-weight: 500;
  }

  .preset-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .preset-buttons button {
    padding: 6px 12px;
    border: 1px solid #4a5568;
    background: #2d3748;
    color: #cbd5e0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  .preset-buttons button:hover {
    background: #4a5568;
    color: white;
  }

  /* Text Walls Popup */
  .text-walls-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .text-walls-dialog {
    background: #1a202c;
    border: 2px solid #4a5568;
    border-radius: 12px;
    padding: 24px;
    width: 400px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }

  .text-walls-dialog h3 {
    margin: 0 0 16px 0;
    color: #cbd5e0;
    font-size: 18px;
  }

  .text-walls-dialog label {
    display: block;
    color: #a0aec0;
    margin-bottom: 6px;
    font-size: 13px;
  }

  .text-walls-dialog input[type="text"],
  .text-walls-dialog input[type="number"],
  .text-walls-dialog select {
    width: 100%;
    padding: 8px 12px;
    background: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #e2e8f0;
    margin-bottom: 12px;
    font-size: 14px;
  }

  .text-walls-buttons {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .text-walls-buttons button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .text-walls-buttons .btn-create {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
  }

  .text-walls-buttons .btn-cancel {
    background: #4a5568;
    color: #cbd5e0;
  }

  .text-walls-buttons button:hover {
    opacity: 0.9;
  }
  </style>

<!-- Text Walls Popup -->
<div id="textWallsOverlay" class="text-walls-overlay">
  <div class="text-walls-dialog">
    <h3>ğŸ”¤ Text Walls Generator</h3>
    
    <label>ğŸ“ Text:</label>
    <input type="text" id="textWallsInput" placeholder="Enter text..." maxlength="50" />
    
    <label>ğŸ“ Font Size:</label>
    <input type="number" id="textWallsFontSize" min="20" max="200" step="10" value="100" />
    
    <label>ğŸ¨ Font Style:</label>
    <select id="textWallsFontStyle">
      <option value="bold Arial">Bold Arial</option>
      <option value="bold Courier">Bold Courier</option>
      <option value="bold Impact">Bold Impact</option>
      <option value="bold Georgia">Bold Georgia</option>
      <option value="900 Arial Black">Extra Bold</option>
    </select>
    
    <label>ğŸ§± Stroke Width (px): <span style="font-size:11px; color:#a0aec0;">(thickness)</span></label>
    <input type="number" id="textWallsBlockSize" min="1" max="8" step="1" value="3" />
    
    <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; cursor: pointer;">
      <input type="checkbox" id="textWallsMerge" style="cursor: pointer;" checked />
      <span>ğŸ”— Merge into single brush <span style="font-size:11px; color:#a0aec0;">(1 object instead of many)</span></span>
    </label>
    
    <div class="text-walls-buttons">
      <button class="btn-cancel" id="textWallsCancel">Cancel</button>
      <button class="btn-create" id="textWallsCreate">Create Walls</button>
    </div>
  </div>
</div>

<!-- Race Save Injector for Editor Mode -->
<script src="race-save-injector.js"></script>

<!-- Top Editor Bar Controller -->
<script>
(function() {
  const topEditorBar = document.getElementById('topEditorBar');
  const sidebar = document.getElementById('editorBar');
  
  // Dropdown toggle
  document.querySelectorAll('.teb-dropdown-toggle').forEach(toggle => {
    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdown = toggle.parentElement;
      const wasOpen = dropdown.classList.contains('open');
      closeAllDropdowns();
      if (!wasOpen) {
        dropdown.classList.add('open');
      }
    });
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.teb-dropdown')) {
      closeAllDropdowns();
    }
  });
  
  function closeAllDropdowns() {
    document.querySelectorAll('.teb-dropdown').forEach(d => d.classList.remove('open'));
  }
  
  // Tool selection - click sidebar tool buttons
  document.querySelectorAll('.teb-menu-item[data-tool]').forEach(item => {
    item.addEventListener('click', () => {
      const toolName = item.dataset.tool;
      // Find matching tool in sidebar by data-tool attribute
      const sidebarTool = document.querySelector(`.rightbar .tool[data-tool="${toolName}"]`);
      if (sidebarTool) {
        sidebarTool.click();
        // Update dropdown icon
        const dropdown = item.closest('.teb-dropdown');
        const toggle = dropdown.querySelector('.teb-dropdown-toggle');
        toggle.textContent = item.textContent.trim();
      }
      closeAllDropdowns();
    });
  });
  
  // Sync settings with sidebar inputs using data-sync attribute
  document.querySelectorAll('[data-sync]').forEach(el => {
    const targetId = el.dataset.sync;
    const target = document.getElementById(targetId);
    if (!target) return;
    
    // Initial sync from sidebar to top bar
    if (el.type === 'checkbox') {
      el.checked = target.checked;
    } else if (el.type === 'color') {
      el.value = target.value;
    } else if (el.tagName === 'SELECT') {
      el.value = target.value;
    } else {
      el.value = target.value;
    }
    
    // Update value display
    const valSpan = el.parentElement.querySelector('.teb-val');
    if (valSpan && el.type === 'range') {
      valSpan.textContent = target.value + (targetId.includes('Slider') || targetId.includes('Speed') ? 'Ã—' : 
                            targetId.includes('Span') || targetId.includes('Angle') ? 'Â°' : 
                            targetId.includes('Duration') ? 'ms' : 'px');
    }
    
    // Two-way sync: top bar -> sidebar
    el.addEventListener('input', () => {
      if (el.type === 'checkbox') {
        target.checked = el.checked;
      } else {
        target.value = el.value;
      }
      target.dispatchEvent(new Event('input', { bubbles: true }));
      
      // Update value display
      if (valSpan && el.type === 'range') {
        valSpan.textContent = el.value + (targetId.includes('Slider') || targetId.includes('Speed') ? 'Ã—' : 
                              targetId.includes('Span') || targetId.includes('Angle') ? 'Â°' : 
                              targetId.includes('Duration') ? 'ms' : 'px');
      }
    });
    
    el.addEventListener('change', () => {
      if (el.tagName === 'SELECT') {
        target.value = el.value;
        target.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
    
    // Two-way sync: sidebar -> top bar
    target.addEventListener('input', () => {
      if (el.type === 'checkbox') {
        el.checked = target.checked;
      } else {
        el.value = target.value;
      }
      if (valSpan && el.type === 'range') {
        valSpan.textContent = target.value + (targetId.includes('Slider') || targetId.includes('Speed') ? 'Ã—' : 
                              targetId.includes('Span') || targetId.includes('Angle') ? 'Â°' : 
                              targetId.includes('Duration') ? 'ms' : 'px');
      }
    });
  });
  
  // Action buttons - click sidebar buttons
  document.querySelectorAll('[data-click]').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.dataset.click;
      const targetBtn = document.getElementById(targetId);
      if (targetBtn) targetBtn.click();
      closeAllDropdowns();
    });
  });
  
  // Toggle sidebar
  const toggleBtn = document.getElementById('tebToggleSidebar');
  if (toggleBtn && sidebar) {
    toggleBtn.addEventListener('click', () => {
      sidebar.style.display = sidebar.style.display === 'none' ? '' : 'none';
      toggleBtn.textContent = sidebar.style.display === 'none' ? 'â˜°' : 'â‰¡';
    });
  }
  
  // Hide top editor bar when game is running
  function updateTopEditorBarVisibility() {
    const isRunning = window.horses && window.horses.length > 0 && 
                      document.getElementById('pauseBtnHUD')?.style.display !== 'none';
    if (topEditorBar) {
      topEditorBar.classList.toggle('hidden', isRunning);
    }
  }
  
  setInterval(updateTopEditorBarVisibility, 500);
  
  const playBtn = document.getElementById('hudPlayTest');
  const stopBtn = document.getElementById('toEditor');
  if (playBtn) playBtn.addEventListener('click', () => setTimeout(updateTopEditorBarVisibility, 100));
  if (stopBtn) stopBtn.addEventListener('click', () => setTimeout(updateTopEditorBarVisibility, 100));
})();
</script>

</body>
</html>
